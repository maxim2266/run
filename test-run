#!/bin/sh -e

SCRIPT="$(basename "$0")"

die() {
	echo >&2 "$SCRIPT: [error]" "$@"
	exit 1
}

log() {
	echo >&2 "$SCRIPT: [info]" "$@"
}

RUN="docker run --network none"

# docker image
IMAGE="${1:?missing image name}"

# cleanup
cleanup() {
    log "cleaning up..."
	IDS="$(docker ps -aqf "ancestor=$IMAGE")"
	[ -z "$IDS" ] || docker rm -f "$IDS"
	docker rmi -f "$IMAGE"
	log "all done."
}

trap cleanup EXIT
trap 'die "interrupted!"' INT TERM HUP QUIT

# test runner
TOTAL=0

test_case() {
	TOTAL=$((TOTAL + 1))
	log "test $TOTAL: $1"
	sh || die 'FAILED'
	log 'passed'
}

# test cases
test_case 'version' <<-EOF
	! $RUN --rm $IMAGE -v
EOF

test_case 'simple invocation' <<-EOF
	$RUN --rm $IMAGE '/bin/sleep 0.1'
EOF

test_case 'simple error propagation' <<-EOF
	$RUN --rm $IMAGE '/bin/sh -c "exit 42"'
	[ \$? -eq 42 ]
EOF

test_case 'invalid command' <<-EOF
    ! $RUN --rm $IMAGE nonexistent-command
EOF

test_case 'two processes' <<-EOF
	$RUN --rm $IMAGE '/bin/sleep 0.2' '/bin/sleep 0.1'
EOF

test_case 'two processes, SIGHUP' <<-EOF
	$RUN --rm $IMAGE -s HUP '/bin/sleep 0.1' '/bin/sleep 0.2'
	[ \$? -eq 129 ]
EOF

test_case 'two processes, SIGHUP ignored' <<-EOF
	$RUN --rm $IMAGE -s HUP -t 1 '/bin/sleep 0.1' '/usr/bin/nohup /bin/sleep 2'
	[ \$? -eq 137 ]
EOF

test_case 'docker stop' <<-EOF
	set -e
	CID=\$($RUN -d $IMAGE -s HUP '/bin/sleep 1' '/bin/sleep 2')
	trap 'docker rm -f "\$CID" >/dev/null' EXIT
	sleep 0.2
	docker stop "\$CID" >/dev/null
	RET="\$(docker wait "\$CID")"
	[ \$RET -eq 143 ]
	docker logs "\$CID"
EOF

test_case 'STDIN handling' <<-EOF
    echo 'ZZZ' | $RUN --rm -i $IMAGE -s TERM /bin/cat | grep -q 'ZZZ'
EOF

test_case 'with daemon' <<-EOF
	$RUN --rm $IMAGE '/bin/sleep 0.1' '/bin/sh -c '\''sleep 1 &'\' 2>&1 \
	| grep '\(ignoring daemons\)'
EOF

log "completed $TOTAL test cases"
